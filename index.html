<!DOCTYPE html>
<html>
    <head>
        <title>Production Performance</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1">
        <link rel="stylesheet" href="style/custom-button.css" type="text/css" />
        <link rel="stylesheet" href="style/jquery.marquee.min.css" type="text/css" />
        <link rel="stylesheet" href="style/mobile/jquery.mobile-1.1.1.css" type="text/css" />
        <link rel="stylesheet" href="style/navbar.css" type="text/css" />
        <link rel="stylesheet" href="style/modal.css" type="text/css" />
        <script type="text/javascript" src="script/localStorage.js"></script>
        <script type="text/javascript" src="script/jquery-1.8.2.min.js"></script>
        <script type="text/javascript" src="script/jquery.marquee.min.js"></script>
        <script type="text/javascript" src="script/mobile/jquery.mobile-1.1.1.min.js"></script>
        <script type="text/javascript">
            <!--
            jQuery.support.cors = true;
            var prevSize;
            var activeButton;
            
            $(document).ready(function(){
                $("#scrolly").marquee({
                    yScroll: "bottom"
                });

                var wnd = $(window);
                var wndSize = function(){
                    return wnd.innerWidth() + "x" + wnd.innerHeight();
                };
                prevSize = wndSize();
                wnd.on("resize", function(){
                    var curSize = wndSize();
                    
                    if (curSize === prevSize) 
                        return;
                    
                    prevSize = curSize;
                    // handler code
                    setMarqueeWidth();
                });
                
                //Button Click Events
                $('#home').click(function(){
                    setContent(0, null);
                    localStorage.setItem('cIndex', 0);
                    updateActiveButton($('#home'));
					$("body").removeClass("loading");
                });
                
                $('#prodstats').click(function(){
                    $.ajax({
                        url: "http://curmobilack.phpfogapp.com/prodstats",
                        dataType: 'jsonp',
                        cache: 'false',
                        beforeSend: function(){
                            $("body").addClass("loading");
                        },
                        complete: function(){
                            $("body").removeClass("loading");
                        },
                        success: function(response){
                            setContent(1, response);
                            localStorage.setItem('prodStats', JSON.stringify(response));
                            localStorage.setItem('cIndex', 1);
                            updateActiveButton($('#prodstats'));
                        },
                        error: function(){
                            restoreActiveButton($('#prodstats'));
                            alert("Error retrieving data");
                        }
                    });
                });
                
                $('#marquee').click(function(){
                    $.ajax({
                        url: "http://curmobilack.phpfogapp.com/marquee",
                        dataType: 'jsonp',
                        cache: 'false',
                        beforeSend: function(){
                            $("body").addClass("loading");
                        },
                        complete: function(){
                            $("body").removeClass("loading");
                        },
                        success: function(response){
                            setContent(2, response);
                            updateActiveButton($('#marquee'));
                        },
                        error: function(){
                            restoreActiveButton($('#marquee'));
                            alert("Error retrieving data");
                        }
                    });
                });
                
                $('#refresh').click(function(){
                    //window.open('', '_self');
                    //window.close();
					window.location.reload();
                });

                setMarqueeWidth();
                initMarquee();
				showLastPage();
				$("body").removeClass('loading');
            });

			function textCounter( field, maxlimit ) {
			  if ( field.value.length > maxlimit )
			  {
				field.value = field.value.substring( 0, maxlimit );
				alert( 'Textarea value can only be 255 characters in length.' );
				return false;
			  }
			}

            //Content Generation
            function setContent(index, response){
                $('#currentView').empty() //Prevent memory leaks
				$(window).scrollTop(0);
                switch (index) {
                    case 2: //Show message input table
                        var msgCount = 0;
						var htmlValue = '<div class="ui-grid-a" id="marqueeTable">';
                        if (response != null && response.success) {
							var countHtml = '<div class="ui-block-a" style="width:10%; text-align:center; margin-top: 15px">@msgCount</div>';
							var textHtml = '<div class="ui-block-b" style="width:85%;"><textarea onkeypress="textCounter(this, 100);" style="overflow:hidden; width:100%;height:95%;" name="Text@msgCount">@msgText</textarea></div>';
                            $.each(response.marquee, function(){
                                msgCount++;
                                if (this.id != msgCount) {
                                    while (msgCount != this.id) {
                                        htmlValue += countHtml.replace('@msgCount',msgCount);
                                        htmlValue += textHtml.replace('@msgCount',msgCount).replace('@msgText','');
                                        msgCount++;
                                    }
                                }
                                htmlValue += countHtml.replace('@msgCount',this.id);
                                htmlValue += textHtml.replace('@msgCount',this.id).replace('@msgText',this.text);
                            });
                        }
                        
                        while (msgCount < 15) {
                            msgCount++;
							htmlValue += countHtml.replace('@msgCount',msgCount);
							htmlValue += textHtml.replace('@msgCount',msgCount).replace('@msgText','');
                        }
                        
                        htmlValue += '</div><button id="btnSave" data-inline="true" data-theme="c" data-icon="check">Save</button>';
                        $('#currentView').html(htmlValue).trigger('create');
						$('#marqueeTable textarea').each(function(index){
							this.cols = parseInt(this.scrollWidth / 8);
							this.rows = 1 + Math.floor( 100 / this.cols );
						});
                        $('#btnSave').click(function(){
                            var msgs = '';
                            $('#marqueeTable textarea').each(function(index){
                                var text = this.value;
                                if (text.length > 0) {
                                    var id = parseFloat(this.name.replace("Text", ""));
                                    if (msgs.length == 0) {
                                        msgs += '[{"id":' + id + ',"text":"' + text + '"}';
                                    }
                                    else {
                                        msgs += ',{"id":' + id + ',"text":"' + text + '"}';
                                    }
                                }
                            });
                            msgs += "]";
                            
                            $.ajax({
                                type: "post",
                                url: "http://curmobilack.phpfogapp.com/marquee",
                                dataType: "json",
                                cache: "false",
                                data: {
                                    marquee: msgs
                                },
                                beforeSend: function(){
                                    $("body").addClass("loading");
                                },
                                complete: function(){
                                    $("body").removeClass("loading");
                                },
                                success: function(response){
                                    if (response == null || !response.success) {
                                        alert("Error saving");
                                    }
                                    else {
                                        updateMarquee(response.marquee);
                                        showLastPage();
                                    }
                                },
                                error: function(response, statusText, errorThrown){
                                    alert("Error posting");
                                }
                            });
                        });
                        break;
                    case 1: //Show Production Performance Data
                        if (response != null && response.success) {
                            var htmlValue = '<div data-role="collapsible-set">';
                            $.each(response.statsInfo, function(){
                                htmlValue += '<div data-role="collapsible" data-theme="' + this.values.state + '" data-content-theme="d" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d" data-inset="true" data-collapsed="true">';
                                htmlValue += '<h2>' + this.values.desc + '</h2>';
                                htmlValue += '<ul data-role="listview" data-theme="c" data-divider-theme="a" data-count-theme="d">';
                                $.each(this.values.items, function(){
                                    htmlValue += '<li data-role="list-divider">' + this.values.desc + '<span class="ui-li-count"> (' + this.values.uom + ')</span></li>';
									htmlValue += '<li><div class="ui-grid-b" style="height:48px">';
									htmlValue += '<div class="ui-block-a"></div>';
									htmlValue += '<div class="ui-block-b" style="text-align: center; margin-top:4px">Actual</div>';
									htmlValue += '<div class="ui-block-c" style="text-align: center; margin-top:4px">Planned</div>';
									htmlValue += '<div class="ui-block-a" style="text-align: center; position: relative; top: -20px">';
                                    htmlValue += '<img src="images/' + (this.values.state ? 'yes' : 'no') + '.png"/>';
									htmlValue += '</div>';
									htmlValue += '<div class="ui-block-b" style="text-align: center; margin-top:4px">' + this.values.actual + '</div>';
									htmlValue += '<div class="ui-block-c" style="text-align: center; margin-top:4px">' + this.values.planned + '</div>';
									htmlValue += '</div></li>';
                                });
                                htmlValue += '</ul></div>';
                            });
                            htmlValue += '</div>';
                            htmlValue += '<span>Last update : ' + response.lastUpdated + '</span><br>';
                            $('#currentView').html(htmlValue).trigger('create');
                        }
                        else {
                            //No production performance data
                            $('#currentView').html('<span>Production performance data unavailable</span>').trigger('create');
                        }
                        break;
                    case 0: //Show jWplayer
                    default:
                        $('#currentView').html('<div style="position: relative; left: -150px; margin-left: 50%;" data-role="content"><iframe id="mediaplayer" src="http://curmobilack.phpfogapp.com/video.html" style="border: 0; width:300px; height:250px; z-index: 100;" /></div>').trigger('create');
                        break;
                }
				$('#mainPage header').trigger('updatelayout');
            }
            
            function showLastPage(){
                if (activeButton != null) {
                    activeButton.removeClass('ui-btn-active');
                }
                var contentIndex = localStorage.getItem('cIndex');
                if (contentIndex == null || contentIndex == 0) {
                    //Show corporate video content
                    setContent(0, null);
                    $('#home').addClass('ui-btn-active');
                    activeButton = $('#home');
                }
                else {
                    //Show production performance content
                    var response = JSON.parse(localStorage.getItem('prodStats'));
                    setContent(1, response);
                    $('#prodstats').addClass('ui-btn-active');
                    activeButton = $('#prodstats');
                }
            }
            
            function setMarqueeWidth(){
                var marqueeWidth = parseFloat(prevSize.substring(0, prevSize.indexOf("x")));
                $("#scrolly").css("width", marqueeWidth.toString() + "px");
				
				$('#marqueeTable textarea').each(function(index){
					this.cols = parseInt(this.scrollWidth / 8);
					this.rows = 1 + Math.floor( 100 / this.cols );
				});
            }
            
            function initMarquee(){
                $.ajax({
                    url: "http://curmobilack.phpfogapp.com/marquee",
                    dataType: 'jsonp',
                    cache: 'false',
                    success: function(response){
                        updateMarquee(response.marquee);
                    },
					error: function(response, statusText, errorThrown){
						updateMarquee(JSON.parse('[{"id":"1","text":"An error occured retrieving the marquee data"},' +
												'{"id":"2","text":"Please check you internet connection and try again"}]'));
					}
                });
            }
            
            function updateMarquee(marquee){
                $('#scrolly').empty() //Prevent memory leaks
                var htmlValue = '';
                $.each(marquee, function(){
                    htmlValue += '<li>' + this.text + '</li>';
                });
                $('#scrolly').html(htmlValue).trigger('create');
                $("#scrolly").marquee({
                    yScroll: "bottom"
                });
            }
            
            function updateActiveButton(newActiveButton){
                if (activeButton != newActiveButton) {
                    activeButton = newActiveButton;
                }
            }
            
            function restoreActiveButton(newActiveButton){
                if (activeButton != newActiveButton) {
                    newActiveButton.removeClass('ui-btn-active');
                    activeButton.addClass('ui-btn-active');
                }
            }
            
            //-->
        </script>
    </head>
    <body class="loading">
        <div id="mainPage" data-role="page" data-theme="d">
            <div data-role="header">
                <div style="text-align:center; width: 100%; background: #FFFFFF" data-role="navbar">
                    <img src="images/logo.png" style="max-width:100%;max-height:100%"/>
                </div>
	            <ul id="scrolly" class="marquee">
					<li>Loading, please wait...</li>
                </ul>
            </div>
            <div id="currentView" data-role="content" data-theme="d">
            </div>
            <div data-role="footer" style="z-index:1500" class="sitenav" data-theme="b" data-position="fixed">
                <div data-role="navbar" class="sitenav">
                    <ul>
                        <li>
                            <a href="#" id="home" data-icon="custom">Video</a>
                        </li>
                        <li>
                            <a href="#" id="prodstats" data-icon="custom">Production</a>
                        </li>
                        <li>
                            <a href="#" id="marquee" data-icon="custom">Marquee</a>
                        </li>
                        <li>
                            <a href="#" id="refresh" data-icon="custom">Refresh</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="modal">
            <!-- Place at bottom of page -->
        </div>
    </body>
</html>
